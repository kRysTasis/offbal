<template>
    <div>
        <v-menu
            offset-x
            left
            transition="slide-x-transition"
            rounded="lg"
        >
            <template #activator="{ attrs, on }">
                <v-btn
                    icon
                    v-bind="attrs"
                    v-on="on"
                >
                    <v-icon color="grey">mdi-dots-horizontal</v-icon>
                </v-btn>
            </template>
            <v-list>
                <v-list-item
                    v-for="(menu, i) in menus"
                    :key="i"
                    @click="menu.call"
                >
                    <v-list-item-icon class="mr-0">
                        <v-icon small v-text="menu.icon"/>
                    </v-list-item-icon>
                    <v-list-item-title>{{ menu.name }}</v-list-item-title>
                </v-list-item>
            </v-list>
        </v-menu>

        <SelectCategorySectionBtn
            @move-category-section='moveCategorySection'
            ref='selectCategorySection'
        />

        <EditTaskDialog
            ref='taskEdit'
        />

    </div>
</template>
<script>
    import { mapActions, mapMutations } from 'vuex'
    import EditTaskDialog from '@/components/common/EditTaskDialog'
    import SelectCategorySectionBtn from '@/components/parts/SelectCategorySectionBtn'

    export default {
        name: 'TaskMenuBtn',
        components: {
            EditTaskDialog,
            SelectCategorySectionBtn,
        },
        props: {
            task: {
                type: Object,
                requied: true,
            },
        },
        data () {
            return {
                menus: [
                    {
                        name: 'タスクを編集',
                        icon: 'mdi-pencil-outline',
                        call: this.showEditTaskDialog,
                    },
                    {
                        name: 'カテゴリーの移動',
                        icon: 'mdi-arrow-right-circle-outline',
                        call: this.showMoveCategoryDialog,
                    },
                    {
                        name: 'タスクの複製',
                        icon: 'mdi-content-copy',
                        call: this.copyTask,
                    },
                    {
                        name: 'タスクの削除',
                        icon: 'mdi-package',
                        call: this.deleteLocalTask,
                    }
                ],
                cloneTask: {},
            }
        },
        created () {
            this.init()
        },
        methods: {
            ...mapMutations([
                'addTask',
                'deleteTask',
            ]),
            ...mapActions([
                'deleteTaskAction',
            ]),
            showEditTaskDialog () {
                this.$refs.taskEdit.open(this.task)
            },
            showMoveCategoryDialog () {
                this.$refs.selectCategorySection.open()
            },
            cloneTaskData () {
                const task = this.task
                this.cloneTask = {
                    category_id: task.target_category,
                    section_id: task.target_section,
                    content: task.content,
                    comment: task.comment,
                    priority: task.priority,
                    label_list: [],
                    deadline_str: task.deadline,
                    remind_str: task.remind,
                }
                for (const i in task.label) {
                    this.cloneTask.label_list.push(task.label[i].id)
                }
            },
            copyTask () {
                this.cloneTaskData()
                this.$axios({
                    url: '/api/task/',
                    method: 'POST',
                    data: this.cloneTask
                })
                .then(res => {
                    console.log(res)
                    this.addTask(res.data)
                })
                .catch(e => {
                    console.log(e)
                })
                this.init()
            },
            deleteLocalTask () {
                this.deleteTaskAction(this.task.id)
            },
            init () {
                this.cloneTask = {
                    category_id: 0,
                    section_id: 0,
                    content: '',
                    comment: '',
                    deadline_str: '',
                    remind_str: '',
                    priority: '1',
                    label_list: [],
                }
            },
            createMoveCategorySectionTaskData (categoryId, sectionId) {
                this.cloneTask = {
                    category_id: categoryId,
                    section_id: sectionId,
                    content: this.task.content,
                    comment: this.task.comment,
                    priority: this.task.priority,
                    label_list: [],
                    deadline_str: this.task.deadline,
                    remind_str: this.task.remind,
                }
                for (const i in this.task.label) {
                    this.cloneTask.label_list.push(this.task.label[i].id)
                }
            },
            moveCategorySection (value) {
                const { target_category: targetCategory, target_section: targetSection } = this.task
                const { category_id: categoryId, section_id: sectionId } = value
                if (targetCategory === categoryId && targetSection === sectionId) return
                this.createMoveCategorySectionTaskData(categoryId, sectionId)
                this.$axios({
                    url: `/api/task/${this.task.id}/`,
                    method: 'PUT',
                    data: this.cloneTask
                })
                .then(res => {
                    console.log(res)
                    this.addTask(res.data)
                    this.deleteTask(this.task)
                })
                .catch(e => {
                    console.log(e)
                })
                this.init()
            }
        }
    }
</script>
<style lang="scss" scoped>
</style>
